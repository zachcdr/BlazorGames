@using Microsoft.AspNetCore.Components;
@using Quarantine.Models;

@if (Group?.Golfers != null)
{
    var golferViews = Group.Golfers.Select(g => new GolferScoreView(g));
    <h5>Totals</h5>
    <table class="table maxwidth">
        <thead>
            <tr>
                <th></th>
                <th>Score</th>
                <th>Dots</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var golfer in golferViews)
            {
                <tr>
                    <th>@golfer.Name</th>
                    <td>@golfer.RoundScore</td>
                    <td>@golfer.TotalDots</td>
                </tr>
            }
        </tbody>
    </table>
    <h5>Score</h5>
    <div class="horizontal-scroll maxwidth" style="margin-bottom: 15px;">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    @foreach (var hole in Group.Golfers.First().Holes)
                    {
                        <th style="cursor: pointer;" @onclick="@(e => GoToHole(hole.Id))">@hole.Id</th>

                        @if (hole.Id == 9)
                        {
                            <th>IN</th>
                        }
                        else if (hole.Id == 18)
                        {
                            <th>OUT</th>
                        }
                    }
                    <th>TOT</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var golfer in Group.Golfers)
                {
                    <tr>
                        <th>@golfer.Name</th>
                        @foreach (var hole in golfer.Holes)
                        {
                            <td>@hole.Score</td>

                            @if (hole.Id == 9)
                            {
                                <th>@golfer.Holes.Where(h => h.Id <= 9).Sum(h => h.Score)</th>
                            }
                            else if (hole.Id == 18)
                            {
                                <th>@golfer.Holes.Where(h => h.Id > 9).Sum(h => h.Score)</th>
                            }
                        }
                        <th>@golfer.Holes.Sum(h => h.Score)</th>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <h5>Dots</h5>
    <div class="horizontal-scroll maxwidth">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    @foreach (var hole in Group.Golfers.First().Holes)
                    {
                        <th>@hole.Id</th>

                        @if (hole.Id == 9)
                        {
                            <th>IN</th>
                        }
                        else if (hole.Id == 18)
                        {
                            <th>OUT</th>
                        }
                    }
                    <th>TOT</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var golfer in Group.Golfers)
                {
                    <tr>
                        <th>@golfer.Name</th>
                        @foreach (var hole in golfer.Holes)
                        {
                            <td>@hole.Dots.Count</td>

                            @if (hole.Id == 9)
                            {
                                <th>@golfer.Holes.Where(h => h.Id <= 9).Sum(h => h.Dots.Count)</th>
                            }
                            else if (hole.Id == 18)
                            {
                                <th>@golfer.Holes.Where(h => h.Id > 9).Sum(h => h.Dots.Count)</th>
                            }
                        }
                        <th>@golfer.Holes.Sum(h => h.Dots.Count)</th>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    [Parameter]
    public GolfGroup Group { get; set; }
    [Parameter]
    public EventCallback<HoleUpdate> HoleUpdate { get; set; }

    private async Task GoToHole(int currentHole)
    {
        await PerformUpdate(currentHole);
    }

    private async Task PerformUpdate(int currentHole)
    {
        Group.Golfers.ForEach(g => g.IsVisible = false);
        await HoleUpdate.InvokeAsync(new Models.HoleUpdate() { Golfers = Group.Golfers, CurrentHole = currentHole, GroupId = Group.Id, CompleteGame = false });
    }
}